<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enlace espejo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0}
    .truck-arrow{will-change: transform}
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API = "http://localhost:8080";
    const qs = new URLSearchParams(location.search);
    const token = qs.get("token");
    const hours = Number(qs.get("hours") || "24");
    if (!token) { alert("Falta token"); throw new Error("No token"); }

    // Colores consistentes con la vista principal
    const ONLINE_COLOR = "#1fa21f";   // verde brillante
    const OFFLINE_COLOR = "#7a7a7a";  // gris tenue

    // Flecha SVG m치s grande (36px)
    function arrowIcon(headingDeg = 0, online = true) {
      return L.divIcon({
        className: "truck-arrow",
        html: `
          <svg width="36" height="36" viewBox="0 0 48 48" style="transform: rotate(${headingDeg}deg); transition: transform 0.3s ease;">
            <polygon points="24,4 38,36 24,30 10,36"
              fill="${online ? ONLINE_COLOR : OFFLINE_COLOR}"
              stroke="rgba(0,0,0,.5)"
              stroke-width="1.5"
              stroke-linejoin="round"
              style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4))" />
          </svg>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
    }

    const map = L.map("map", { zoomControl: true }).setView([19.243,-103.726], 12);
    map.zoomControl.setPosition("bottomleft");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

    const poly = L.polyline([], { weight: 4, opacity: 0.85 }).addTo(map);
    const marker = L.marker([19.243,-103.726], { icon: arrowIcon(0, false), zIndexOffset: 2000 }).addTo(map);

    function apply(d){
      const online = !d.stale; // <-- usa campo 'stale' para definir color
      marker.setLatLng([d.lat,d.lon]);
      marker.setIcon(arrowIcon(d.headingDeg ?? 0, online));
      map.setView([d.lat,d.lon]);
    }

    // 칔ltima posici칩n
    fetch(`${API}/api/mirror/${token}/latest`)
      .then(r=>r.ok?r.json():null)
      .then(d=>{ if(d){ apply(d); } });

    // Recorrido hist칩rico
    fetch(`${API}/api/mirror/${token}/trail?hours=${encodeURIComponent(hours)}`)
      .then(r=>r.ok?r.json():null)
      .then(b=>{
        if (b && Array.isArray(b.trail)) {
          poly.setLatLngs(b.trail.map(p=>[p.lat,p.lon]));
        }
      });

    // Flujo en vivo (SSE)
    const ev = new EventSource(`${API}/api/mirror/${token}/stream`);
    ev.addEventListener("position", e => {
    const d = JSON.parse(e.data);
    console.log("[MIRROR FIX]", d);  // 游녣 esto imprimir치 lo que realmente llega
    apply(d);
    const pts = poly.getLatLngs(); 
    pts.push([d.lat,d.lon]); 
    poly.setLatLngs(pts);
    });
  </script>
</body>
</html>
